NMAP:

Nmap (Network Mapper) is a open-source tool used for network discovery and security auditing. It also assists in the exploration of network hosts and services, providing information about open ports, operating systems, and other details.

First we need to discover the online systems before port-scanning, so that to save us the time of doing port-scan on offline systems and help us stay quiet on the network.

=>  ARP scan : Address Resolution Protocol (ARP) is responsible for finding the MAC (hardware) address related to a specific IP address. It works by broadcasting an ARP query, "Who has this IP address? Tell me." And the response is of the form, "The IP address is at this MAC address." This scan uses ARP requests to discover live hosts.

=>  ICMP scan :  Internet Control Message Protocol. It's a set of communication rules used by network devices to communicate data transmission errors. ICMP is a supporting protocol in the Internet protocol suite.  This scan uses ICMP requests to identify live hosts.

=>  TCP/UDP scan : This scan sends packets to TCP ports and UDP ports to determine live hosts.

We will also use 2 scanners: arp-scan and masscan

Nmap is an industry-standard tool for mapping networks, identifying live hosts, and discovering running services. Nmap’s scripting engine can further extend its functionality, from fingerprinting services to exploiting vulnerabilities. A Nmap scan usually goes through the steps shown in the figure below, although many are optional and depend on the command-line arguments you provide.

1.  Enumerate Targets
2.  Discover Live hosts
3.  Reverse DNS lookup
4.  Scan ports
5.  Detect Versions
6.  Detect OS
7.  Traceroot
8.  Scripts
9.  Write output

Active Reconnaissance:

Active reconnaissance involves actively seeking information about a network, usually to identify and understand the devices connected to it.
Discovery of Hosts or Subnet:

In the context of network exploration, we want to find out more about a group of computers (hosts) or a range of IP addresses (subnet).
ARP (Address Resolution Protocol):

ARP is a protocol used to find the hardware address (MAC address) of a device on the same local network.
It's like asking, "Who has this specific IP address, and what's your hardware address?"
Purpose of ARP Queries:

ARP queries help establish communication at the link-layer (a low-level networking concept) by obtaining MAC addresses.
Inference of Online Hosts:

When your computer sends an ARP query and receives a response, it infers that the host is online and reachable on the local network.
Limitations Across Subnets:

If your computer is on a different subnet (a portion of the network with a distinct IP address range), ARP queries cannot cross the router to reach devices on another subnet.
Role of Default Gateway (Router):

All packets generated by your scanner to reach devices on a different subnet will be directed through the default gateway (router).
However, ARP queries themselves, being link-layer requests, won't be forwarded by the router to the other subnet.
Subnet Boundaries:

ARP packets are limited to the local subnet; they cannot traverse beyond the subnet boundary.
Analogy:

Imagine your computer is in a neighborhood, and ARP queries are like asking neighbors for someone's phone number. If the person is in a different neighborhood, you can't directly ask their neighbors, you have to go through a central phone directory (router).
Conclusion:

ARP is effective for local network discovery but has limitations when trying to explore devices on different subnets due to the nature of how routers handle ARP packets.


1. **Scanning Specific IP Addresses:**
   - `MACHINE_IP`, `scanme.nmap.org`, and `example.com` are three specific IP addresses that Nmap will scan individually.

2. **Scanning IP Address Range:**
   - Using a range like `10.11.12.15-20` means Nmap will scan a sequence of IP addresses within that range.
   - In this example, it will scan 6 IP addresses: `10.11.12.15`, `10.11.12.16`, ..., and `10.11.12.20`.

3. **Scanning Subnet:**
   - If you provide a subnet like `MACHINE_IP/30`, Nmap will scan all IP addresses within that subnet.
   - In this case, it will scan 4 IP addresses, as the "/30" implies a subnet with a total of 4 IP addresses.

4. **Using a File for Input:**
   - You can create a file, let's say `list_of_hosts.txt`, containing a list of IP addresses or hostnames.
   - Nmap can read this file with the `-iL` option: `nmap -iL list_of_hosts.txt`.
   
5. **Checking List of Hosts without Scanning:**
   - To preview the list of hosts that Nmap will scan without actually scanning them, you can use: `nmap -sL TARGETS`.
   - This option provides a detailed list of hosts without performing the actual scan. Note that Nmap will attempt reverse-DNS resolution to obtain host names.

6. **DNS Resolution and Privacy Consideration:**
   - Nmap, by default, attempts reverse-DNS resolution to get host names, potentially revealing information.
   - If you want to skip DNS resolution for privacy reasons, you can add the `-n` option: `nmap -sL -n TARGETS`.

In summary, Nmap provides flexibility in defining targets for scanning, whether it's specific IP addresses, a range, a subnet, or using a file. Additionally, the `-sL` option allows you to preview the list of hosts that Nmap will scan without actually initiating the scan, with the option to skip DNS resolution if needed.


To discover live hosts

ARP (Address Resolution Protocol) from Link Layer:

ARP operates at the link layer (Layer 2) and is used to map an IP address to a MAC address on a local network.
By sending ARP requests, a device can determine if a host with a particular IP address is active and reachable on the local network.

ICMP (Internet Control Message Protocol) from Network Layer:

ICMP operates at the network layer (Layer 3) and is commonly used for network diagnostics.
The "ping" command, which uses ICMP Echo Request and Echo Reply messages, can be employed to check if a host is alive and responsive.

TCP (Transmission Control Protocol) from Transport Layer:

TCP operates at the transport layer (Layer 4) and is a connection-oriented protocol.
Tools like Nmap often use TCP SYN scans to discover live hosts. They send a TCP SYN packet to the target's port, and if a response is received, it indicates the host is live.

UDP (User Datagram Protocol) from Transport Layer:

UDP also operates at the transport layer (Layer 4) and is a connectionless protocol.
Tools like Nmap may use UDP probes to check for live hosts. The absence of an ICMP unreachable message or a response to a specific UDP service request can indicate the host is live.

ICMP types: https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml


ARP (Address Resolution Protocol):

Purpose: To find the MAC (hardware) address associated with a specific IP address on the same local network segment.
Operation: Sends a frame to the broadcast address, asking the computer with a specific IP address to respond with its MAC address.
ICMP (Internet Control Message Protocol):

Purpose: ICMP has various types for different purposes, and ICMP ping commonly uses Type 8 (Echo) and Type 0 (Echo Reply).
ICMP Ping Process: Preceded by an ARP query when pinging a system on the same subnet. Type 8 (Echo) is sent, and the response (Type 0 - Echo Reply) indicates the host is alive.
TCP and UDP for Network Scanning:

Transport Layers: TCP and UDP operate at the transport layer (Layer 4).
Network Scanning: Scanners can send specially-crafted packets to common TCP or UDP ports on a target to check for responses.
Efficiency: This method is efficient, especially when ICMP Echo is blocked. It helps identify live hosts and open ports.

Sending Ping requests will first send ARP requests and get ARP response. First device to respond will be the router and then the requested device. only at the first the ARP request is sent.. if we send Ping request again we will directly get Ping response from the device.

nmap -PR -sn IP/subnet
Nmap sends ARP requests to all the target computers, and those online should send an ARP reply back with the MAC address

If we use Wireshark to get this traffic. It shows what packets were sent and received with information like MAC address, IP address, subnet, time.

Detailed info on arp-scan
https://www.royhills.co.uk/wiki/index.php/Main_Page

Devices on the same subnet and routers will only respond to ARP requests. switches won't respond.

**TCP SYN Ping:**

- **Method:** Send a packet with the SYN flag to a TCP port (e.g., default port 80) and wait for a response.
- **Response:** An open port replies with SYN/ACK; a closed port results in RST. The goal is to check for any response to infer if the host is up.
- **Nmap Syntax:** Use `-PS` followed by the port number, range, list, or combination (e.g., `-PS80,443,8080`).

**TCP ACK Ping:**

- **Method:** Send a packet with an ACK flag; typically uses port 80 by default.
- **Response:** Expect an RST flag response, indicating the host is up. Privileged users can skip the 3-way handshake.
- **Nmap Syntax:** Use `-PA` followed by the port number, range, list, or combination (e.g., `-PA80,443,8080`).

**UDP Ping:**

- **Method:** Send UDP packets; no reply expected for open ports, but closed ports trigger an ICMP port unreachable response.
- **Response:** ICMP port unreachable for closed UDP ports indicates the host is up.
- **Nmap Syntax:** Use `-PU` similar to TCP SYN and ACK ping (e.g., `-PU -sn MACHINE_IP/24`).

**Privilege Requirement:**

- TCP SYN Ping doesn't require privileged access.
- TCP ACK Ping requires privileged access, as it sends TCP packets without completing the 3-way handshake.
- UDP Ping also requires privileged access.

**Nmap Syntax Examples:**

- To run TCP SYN ping on telnet port (23): `-PS23`.

**Masscan (Bonus):**

- Masscan, a more aggressive tool, uses a similar approach for fast network scans.
- Examples: `masscan MACHINE_IP/24 -p443`, `masscan MACHINE_IP/24 -p80,443`.

**Note:**

- Understanding different ping scan techniques (TCP SYN, TCP ACK, UDP) provides flexibility in discovering live hosts.
- Privileged access allows skipping certain handshake steps for faster scanning.


DNS:Domain Name System (DNS) is the protocol responsible for resolving hostnames, such as tryhackme.com, to their respective IP addresses.

Nmap’s default behaviour is to use reverse-DNS online hosts. Because the hostnames can reveal a lot, this can be a helpful step. However, if you don’t want to send such DNS queries, you use -n to skip this step.

By default, Nmap will look up online hosts; however, you can use the option -R to query the DNS server even for offline hosts. If you want to use a specific DNS server, you can add the --dns-servers DNS_SERVER option.

Scan Type	                      Example Command
ARP Scan	                      sudo nmap -PR -sn MACHINE_IP/24
ICMP Echo Scan	                sudo nmap -PE -sn MACHINE_IP/24
ICMP Timestamp Scan            	sudo nmap -PP -sn MACHINE_IP/24
ICMP Address Mask Scan	        sudo nmap -PM -sn MACHINE_IP/24
TCP SYN Ping Scan	              sudo nmap -PS22,80,443 -sn MACHINE_IP/30
TCP ACK Ping Scan	              sudo nmap -PA22,80,443 -sn MACHINE_IP/30
UDP Ping Scan	                  sudo nmap -PU53,161,162 -sn MACHINE_IP/30

Remember to add -sn if you are only interested in host discovery without port-scanning. Omitting -sn will let Nmap default to port-scanning the live hosts.

Option	    Purpose
-n	        no DNS lookup
-R	        reverse-DNS lookup for all hosts
-sn	        host discovery only

